<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ØªØªØ¨Ø¹ Ø§Ù„Ø¹Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ - ØªØ­ÙƒÙ… ÙƒØ§Ù…Ù„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8fafc; /* slate-50 */
            color: #334155; /* slate-700 */
        }
        
        /* Modern Glass/Card Styling */
        .modern-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid #f1f5f9;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .modern-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
        }
        
        /* Custom Animated Checkbox */
        .habit-checkbox {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #cbd5e1; /* slate-300 */
            border-radius: 0.375rem; /* rounded-md */
            background-color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 0 auto;
        }
        
        .habit-checkbox:hover {
            border-color: #fb7185; /* rose-400 */
            transform: scale(1.05);
        }

        .habit-checkbox:checked {
            background-color: #f43f5e; /* rose-500 */
            border-color: #f43f5e;
            transform: scale(1.1) rotate(5deg);
        }
        
        .habit-checkbox:checked::after {
            content: 'âœ”';
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
        }

        /* Scrollbar customization */
        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #f8fafc; 
            border-radius: 8px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 8px;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        /* Table specifics */
        th, td { border-bottom: 1px solid #f1f5f9; border-left: 1px solid #f8fafc; }
        thead th { border-bottom: 2px solid #e2e8f0; }
        
        /* Sticky column shadow for nice depth */
        .sticky-col-shadow {
            box-shadow: -4px 0 10px -2px rgba(0,0,0,0.05);
        }

        /* Gradient Text */
        .text-gradient {
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-image: linear-gradient(to right, #f43f5e, #be123c);
        }

        /* Modal Styles */
        .modal-bg {
            background-color: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="p-4 md:p-8 bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen relative">

    <div class="max-w-[1400px] mx-auto space-y-6">
        
        <!-- Top Section -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- Settings Box -->
            <div class="lg:col-span-3 space-y-6 flex flex-col justify-between">
                <div class="modern-card p-6 flex flex-col justify-center items-center h-full relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 w-32 h-32 bg-rose-100 rounded-full opacity-50 blur-2xl pointer-events-none"></div>
                    <div class="absolute -left-4 -bottom-4 w-24 h-24 bg-blue-100 rounded-full opacity-50 blur-2xl pointer-events-none"></div>
                    
                    <h1 class="font-extrabold text-2xl tracking-wider uppercase text-gradient z-10 text-center leading-tight mb-4">Ù…ØªØªØ¨Ø¹ Ø§Ù„Ø¹Ø§Ø¯Ø§Øª</h1>
                    
                    <div class="flex flex-col gap-3 w-full z-10">
                        <div class="flex justify-between items-center bg-white/60 p-2 rounded-lg border border-rose-100 shadow-sm">
                            <span class="text-xs font-bold text-slate-500">Ø§Ù„Ø³Ù†Ø©</span>
                            <select id="year-select" class="bg-transparent text-sm font-bold text-slate-700 outline-none cursor-pointer" onchange="handleCalendarChange()"></select>
                        </div>
                        <div class="flex justify-between items-center bg-white/60 p-2 rounded-lg border border-rose-100 shadow-sm">
                            <span class="text-xs font-bold text-slate-500">Ø§Ù„Ø´Ù‡Ø±</span>
                            <select id="month-select" class="bg-transparent text-sm font-bold text-slate-700 outline-none cursor-pointer" onchange="handleCalendarChange()">
                                <option value="0">ÙŠÙ†Ø§ÙŠØ±</option><option value="1">ÙØ¨Ø±Ø§ÙŠØ±</option><option value="2">Ù…Ø§Ø±Ø³</option>
                                <option value="3">Ø£Ø¨Ø±ÙŠÙ„</option><option value="4">Ù…Ø§ÙŠÙˆ</option><option value="5">ÙŠÙˆÙ†ÙŠÙˆ</option>
                                <option value="6">ÙŠÙˆÙ„ÙŠÙˆ</option><option value="7">Ø£ØºØ³Ø·Ø³</option><option value="8">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
                                <option value="9">Ø£ÙƒØªÙˆØ¨Ø±</option><option value="10">Ù†ÙˆÙÙ…Ø¨Ø±</option><option value="11">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
                            </select>
                        </div>
                        <button onclick="openAddHabitModal()" class="mt-2 w-full bg-gradient-to-r from-rose-500 to-rose-600 text-white hover:from-rose-600 hover:to-rose-700 transition-all py-2 rounded-lg text-sm font-bold shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                            + Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©
                        </button>
                    </div>
                </div>
            </div>

            <!-- Line Chart (Global Progress Trend) -->
            <div class="lg:col-span-6 modern-card p-5 flex flex-col h-full relative overflow-hidden">
                <div class="flex justify-between items-center mb-4 z-10">
                    <h2 class="text-sm font-bold text-slate-700 flex items-center gap-2">
                        <svg class="w-4 h-4 text-rose-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                        Ù…Ù†Ø­Ù†Ù‰ Ø§Ù„ØªÙ‚Ø¯Ù… Ø®Ù„Ø§Ù„ Ø§Ù„Ø´Ù‡Ø±
                    </h2>
                </div>
                <div class="flex-grow relative h-32 w-full z-10">
                    <canvas id="lineChart"></canvas>
                </div>
            </div>

            <!-- Donut Chart (Overall Progress) -->
            <div class="lg:col-span-3 modern-card p-5 flex flex-col items-center justify-center relative">
                <h2 class="text-sm font-bold text-slate-700 w-full text-center mb-2">Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</h2>
                <div class="w-32 h-32 mt-2 relative">
                    <canvas id="donutChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center flex-col">
                        <span id="overall-percentage" class="font-bold text-xl text-slate-800 transition-transform duration-300">0%</span>
                    </div>
                </div>
                <div class="flex justify-between w-full mt-4 text-xs font-medium px-4">
                    <div class="flex flex-col items-center"><span class="w-2 h-2 rounded-full bg-slate-200 mb-1"></span><span id="overall-left" class="text-slate-500">Ù…ØªØ¨Ù‚ÙŠ: 0%</span></div>
                    <div class="flex flex-col items-center"><span class="w-2 h-2 rounded-full bg-rose-500 mb-1"></span><span id="overall-completed" class="text-rose-600 font-bold">Ù…ÙƒØªÙ…Ù„: 0%</span></div>
                </div>
            </div>
        </div>

        <!-- Middle Section -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- Weekly Overview (Bars) -->
            <div class="lg:col-span-9 modern-card p-5">
                <div class="grid grid-cols-12 gap-4 h-full">
                    <div class="col-span-2 flex flex-col justify-between h-full border-l border-slate-100 pl-4">
                        <h2 class="text-sm font-bold text-slate-700 mb-4">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</h2>
                        <div class="text-center bg-slate-50 rounded-lg p-3 border border-slate-100 mb-4">
                            <div class="text-[10px] font-medium text-slate-500 uppercase">Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ</div>
                            <div id="global-progress-fraction" class="text-lg font-bold text-rose-600">0/0</div>
                            <div id="global-progress-percent" class="text-xs text-slate-400">0%</div>
                        </div>
                        <div class="text-[10px] space-y-2 font-semibold text-slate-500 text-right pr-2">
                            <div class="flex items-center gap-1 justify-end"><span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>Ù…ÙƒØªÙ…Ù„</div>
                            <div class="flex items-center gap-1 justify-end"><span class="w-1.5 h-1.5 rounded-full bg-blue-400"></span>Ø§Ù„Ù‡Ø¯Ù</div>
                            <div class="flex items-center gap-1 justify-end"><span class="w-1.5 h-1.5 rounded-full bg-slate-300"></span>Ù…ØªØ¨Ù‚ÙŠ</div>
                        </div>
                    </div>
                    
                    <div class="col-span-10 flex flex-col pl-2">
                         <div id="weekly-overview-bars" class="flex-grow flex items-end justify-between px-1 h-32 border-b border-slate-200 pb-2 mb-3">
                             <!-- Bars injected by JS -->
                         </div>
                         <div id="weekly-overview-stats" class="flex justify-between px-1 text-[10px] text-center font-medium text-slate-400">
                             <!-- Stats injected by JS -->
                         </div>
                    </div>
                </div>
            </div>

            <!-- Top Habits -->
            <div class="lg:col-span-3 modern-card p-5 flex flex-col">
                <h2 class="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <span class="text-rose-500 text-lg">â˜…</span> Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ø§Ø¯Ø§Øª
                </h2>
                <div id="top-habits-list" class="flex-grow flex flex-col justify-start space-y-2 text-xs overflow-y-auto max-h-48 pr-1">
                    <!-- List injected by JS -->
                </div>
            </div>
        </div>

        <!-- Bottom Section: The Main Interactive Table -->
        <div class="modern-card overflow-hidden">
            <div class="bg-rose-50/50 px-5 py-3 border-b border-rose-100/50 flex justify-between items-center">
                <h2 class="font-bold text-rose-900">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h2>
                <div class="flex gap-2">
                    <span id="table-year-badge" class="text-xs font-bold bg-white px-3 py-1 rounded-full text-rose-600 shadow-sm border border-rose-100"></span>
                    <span id="table-month-badge" class="text-xs font-bold bg-white px-3 py-1 rounded-full text-rose-600 shadow-sm border border-rose-100"></span>
                </div>
            </div>
            <div class="table-container overflow-x-auto p-1">
                <table class="w-full text-center border-collapse text-[11px]" id="habit-table">
                    <!-- Generated by JS -->
                </table>
            </div>
        </div>

    </div>

    <!-- Modal for Adding New Habit -->
    <div id="addHabitModal" class="fixed inset-0 modal-bg z-50 hidden flex justify-center items-center opacity-0 transition-opacity duration-300">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-96 transform scale-95 transition-transform duration-300 relative">
            <div class="absolute top-0 right-0 w-full h-2 bg-gradient-to-r from-rose-400 to-rose-600 rounded-t-2xl"></div>
            <h3 class="text-xl font-bold mb-6 text-slate-800 mt-2">Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø© ğŸ¯</h3>
            <div class="space-y-4">
                <div class="flex gap-3">
                    <div class="w-1/4">
                        <label class="block text-xs font-bold text-slate-500 mb-1">Ø£ÙŠÙ‚ÙˆÙ†Ø©</label>
                        <input type="text" id="newHabitIcon" value="âœ¨" class="w-full border border-slate-200 bg-slate-50 p-2.5 rounded-lg text-lg text-center outline-none focus:border-rose-400 focus:ring-1 focus:ring-rose-400 transition-all">
                    </div>
                    <div class="w-3/4">
                        <label class="block text-xs font-bold text-slate-500 mb-1">Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¯Ø©</label>
                        <input type="text" id="newHabitName" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©..." class="w-full border border-slate-200 bg-slate-50 p-2.5 rounded-lg text-sm outline-none focus:border-rose-400 focus:ring-1 focus:ring-rose-400 transition-all">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…)</label>
                    <input type="number" id="newHabitGoal" value="30" min="1" max="31" class="w-full border border-slate-200 bg-slate-50 p-2.5 rounded-lg text-sm outline-none focus:border-rose-400 focus:ring-1 focus:ring-rose-400 transition-all">
                </div>
            </div>
            <div class="mt-8 flex justify-end space-x-3 space-x-reverse">
                <button onclick="closeAddHabitModal()" class="px-5 py-2 text-slate-500 rounded-lg text-sm font-bold hover:bg-slate-100 transition-colors">Ø¥Ù„ØºØ§Ø¡</button>
                <button onclick="saveNewHabit()" class="px-5 py-2 bg-rose-500 text-white rounded-lg text-sm font-bold hover:bg-rose-600 shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5">Ø­ÙØ¸ ÙˆØ¥Ø¶Ø§ÙØ©</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DYNAMIC CONFIGURATION & DATA ---
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth(); // 0 = Jan, 11 = Dec
        
        let DAYS_IN_MONTH = 30;
        let DAYS_OF_WEEK = [];
        let WEEKS = [];
        
        const ARABIC_DAYS = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
        const MONTH_NAMES = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
        
        let habitsData = [
            { id: 0, name: 'Ø§Ù„Ø¬Ø±ÙŠ 30 Ø¯Ù‚ÙŠÙ‚Ø©', goal: 30, icon: 'ğŸƒâ€â™‚ï¸' },
            { id: 1, name: 'Ø§Ù„ØªØ£Ù…Ù„ ÙˆØ§Ù„Ø§Ø³ØªØ±Ø®Ø§Ø¡', goal: 25, icon: 'ğŸ§˜â€â™‚ï¸' },
            { id: 2, name: 'Ø§Ù„Ø¹Ù†Ø§ÙŠØ© Ø§Ù„Ø´Ø®ØµÙŠØ©', goal: 20, icon: 'ğŸš¿' },
            { id: 3, name: 'ÙˆØ¬Ø¨Ø§Øª ØµØ­ÙŠØ©', goal: 25, icon: 'ğŸ¥—' },
            { id: 4, name: 'Ø´Ø±Ø¨ 2 Ù„ØªØ± Ù…Ø§Ø¡', goal: 25, icon: 'ğŸ’§' },
            { id: 5, name: 'Ù‚Ø±Ø§Ø¡Ø© 20 ØµÙØ­Ø©', goal: 15, icon: 'ğŸ“š' }
        ];

        let state = [];
        let donutChartInst = null;
        let lineChartInst = null;

        // --- 2. CALENDAR INITIALIZATION ---

        function initCalendarSelects() {
            const yearSelect = document.getElementById('year-select');
            yearSelect.innerHTML = '';
            for(let y = currentYear - 5; y <= currentYear + 5; y++) {
                yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
            }
            yearSelect.value = currentYear;
            document.getElementById('month-select').value = currentMonth;
        }

        function calculateCalendarData() {
            DAYS_IN_MONTH = new Date(currentYear, currentMonth + 1, 0).getDate();
            const startDayIndex = new Date(currentYear, currentMonth, 1).getDay();

            DAYS_OF_WEEK = [];
            for (let i = 0; i < DAYS_IN_MONTH; i++) {
                DAYS_OF_WEEK.push(ARABIC_DAYS[(startDayIndex + i) % 7]);
            }

            WEEKS = [];
            let weekCount = 1;
            let currentWeekDays = 0;
            
            for (let i = 0; i < DAYS_IN_MONTH; i++) {
                currentWeekDays++;
                let currentDayName = DAYS_OF_WEEK[i];
                let isLastDayOfMonth = (i === DAYS_IN_MONTH - 1);
                
                if (currentDayName === 'Ø§Ù„Ø³Ø¨Øª' || isLastDayOfMonth) {
                    WEEKS.push({ name: `Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${weekCount}`, days: currentWeekDays });
                    weekCount++;
                    currentWeekDays = 0;
                }
            }

            // Generate state based on selected month (in a real app you'd load from DB)
            state = habitsData.map(() => new Array(DAYS_IN_MONTH).fill(false));
            
            // Generate some random mockup data just for visually appealing testing
            for(let h=0; h<habitsData.length; h++) {
                for(let d=0; d<DAYS_IN_MONTH; d++) { 
                    if(Math.random() > 0.6) state[h][d] = true;
                }
            }

            document.getElementById('table-year-badge').innerText = `Ø§Ù„Ø³Ù†Ø©: ${currentYear}`;
            document.getElementById('table-month-badge').innerText = `Ø§Ù„Ø´Ù‡Ø±: ${MONTH_NAMES[currentMonth]}`;
        }

        function handleCalendarChange() {
            currentYear = parseInt(document.getElementById('year-select').value);
            currentMonth = parseInt(document.getElementById('month-select').value);
            
            calculateCalendarData();
            rebuildUI();
        }

        // --- 3. MODAL LOGIC ---

        function openAddHabitModal() {
            const modal = document.getElementById('addHabitModal');
            const modalContent = modal.querySelector('div');
            modal.classList.remove('hidden');
            
            // Animation
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);
            
            document.getElementById('newHabitGoal').max = DAYS_IN_MONTH;
            document.getElementById('newHabitGoal').value = DAYS_IN_MONTH;
        }

        function closeAddHabitModal() {
            const modal = document.getElementById('addHabitModal');
            const modalContent = modal.querySelector('div');
            
            modal.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                document.getElementById('newHabitName').value = '';
                document.getElementById('newHabitIcon').value = 'âœ¨';
            }, 300);
        }

        function saveNewHabit() {
            const name = document.getElementById('newHabitName').value.trim();
            const icon = document.getElementById('newHabitIcon').value.trim() || 'âœ¨';
            const goal = parseInt(document.getElementById('newHabitGoal').value);
            
            if(!name) { alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¯Ø©"); return; }
            if(isNaN(goal) || goal <= 0) { alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‡Ø¯Ù ØµØ­ÙŠØ­"); return; }

            const newId = habitsData.length > 0 ? habitsData[habitsData.length - 1].id + 1 : 0;
            habitsData.push({ id: newId, name: name, icon: icon, goal: goal });
            state.push(new Array(DAYS_IN_MONTH).fill(false));
            
            closeAddHabitModal();
            rebuildUI();
        }

        // --- 4. CALCULATIONS ---

        function calculateHabitStats(habitIndex) {
            const days = state[habitIndex];
            const completed = days.filter(d => d).length;
            const goal = habitsData[habitIndex].goal;
            const left = Math.max(0, goal - completed);
            const percentage = goal === 0 ? 0 : Math.min(100, Math.round((completed / goal) * 100));

            let currentStreak = 0; let maxStreak = 0; let tempStreak = 0;

            for (let i = days.length - 1; i >= 0; i--) {
                if (days[i]) currentStreak++; else break; 
            }

            for (let i = 0; i < days.length; i++) {
                if (days[i]) {
                    tempStreak++;
                    if (tempStreak > maxStreak) maxStreak = tempStreak;
                } else { tempStreak = 0; }
            }

            return { completed, goal, left, percentage, currentStreak, maxStreak };
        }

        function calculateGlobalStats() {
            let totalCompleted = 0;
            let totalGoal = 0;
            const dailyCompletions = new Array(DAYS_IN_MONTH).fill(0);
            const dailyGoals = new Array(DAYS_IN_MONTH).fill(habitsData.length); 

            habitsData.forEach((habit, hIdx) => {
                totalGoal += habit.goal;
                state[hIdx].forEach((isChecked, dIdx) => {
                    if (isChecked) {
                        totalCompleted++;
                        dailyCompletions[dIdx]++;
                    }
                });
            });

            const overallPercentage = totalGoal === 0 ? 0 : Math.round((totalCompleted / totalGoal) * 100);

            const habitsWithStats = habitsData.map((h, i) => {
                const stats = calculateHabitStats(i);
                return { name: h.name, icon: h.icon, percentage: stats.percentage };
            });
            habitsWithStats.sort((a, b) => b.percentage - a.percentage);
            const topHabits = habitsWithStats.slice(0, 8);

            return { totalCompleted, totalGoal, overallPercentage, dailyCompletions, dailyGoals, topHabits };
        }

        // --- 5. RENDERING (MODERN UI) ---

        function renderTable() {
            const table = document.getElementById('habit-table');
            let html = '';

            // --- THEAD ---
            html += '<thead>';
            html += `<tr class="bg-white">
                <th rowspan="3" class="p-3 w-48 font-bold text-sm text-slate-800 sticky right-0 bg-white z-10 sticky-col-shadow text-right">Ø§Ù„Ø¹Ø§Ø¯Ø©</th>
                <th rowspan="3" class="p-2 w-12 font-bold text-slate-500 bg-slate-50 border-r border-slate-100">Ø§Ù„Ù‡Ø¯Ù</th>`;
            
            WEEKS.forEach((week, wIdx) => {
                let borderClass = wIdx > 0 ? 'border-r-2 border-slate-200' : '';
                html += `<th colspan="${week.days}" class="p-2 font-bold text-slate-600 bg-slate-50 rounded-t-lg ${borderClass}">${week.name}</th>`;
            });
            
            html += `<th rowspan="3" class="p-2 w-12 font-bold text-emerald-600 bg-emerald-50 border-r-2 border-slate-200">Ù…ÙƒØªÙ…Ù„</th>
                <th rowspan="3" class="p-2 w-12 font-bold text-slate-500 bg-slate-50">Ù…ØªØ¨Ù‚ÙŠ</th>
                <th rowspan="3" class="p-2 w-12 font-bold text-rose-600 bg-rose-50">%</th>
                <th rowspan="3" class="p-2 w-32 font-bold text-slate-600 bg-slate-50">Ø§Ù„ØªÙ‚Ø¯Ù…</th>
                <th rowspan="3" class="p-2 w-16 font-bold text-amber-600 bg-amber-50 leading-tight">Ø³Ù„Ø³Ù„Ø©<br>Ø­Ø§Ù„ÙŠØ©</th>
                <th rowspan="3" class="p-2 w-16 font-bold text-purple-600 bg-purple-50 leading-tight">Ø£Ø·ÙˆÙ„<br>Ø³Ù„Ø³Ù„Ø©</th>
            </tr>`;

            html += `<tr class="bg-white">`;
            for(let i=0; i<DAYS_IN_MONTH; i++) {
                let isWeekEndDay = (i > 0 && DAYS_OF_WEEK[i-1] === 'Ø§Ù„Ø³Ø¨Øª');
                let classes = "p-1 font-medium text-[9px] text-slate-400 uppercase tracking-wider";
                if(isWeekEndDay) classes += " border-r-2 border-slate-200"; 
                html += `<th class="${classes}">${DAYS_OF_WEEK[i]}</th>`;
            }
            html += `</tr>`;

            html += `<tr class="bg-white border-b-2 border-slate-200">`;
            for(let i=1; i<=DAYS_IN_MONTH; i++) {
                 let isWeekEndDay = (i > 1 && DAYS_OF_WEEK[i-2] === 'Ø§Ù„Ø³Ø¨Øª');
                 let classes = "p-1.5 font-bold text-slate-700 text-xs";
                 let isWeekend = (DAYS_OF_WEEK[i-1] === 'Ø§Ù„Ø¬Ù…Ø¹Ø©' || DAYS_OF_WEEK[i-1] === 'Ø§Ù„Ø³Ø¨Øª');
                 if(isWeekend) classes += " text-rose-400"; 
                 if(isWeekEndDay) classes += " border-r-2 border-slate-200";
                 html += `<th class="${classes}">${i}</th>`;
            }
            html += `</tr></thead>`;

            // --- TBODY ---
            html += `<tbody>`;
            habitsData.forEach((habit, hIdx) => {
                html += `<tr class="border-b border-slate-100 hover:bg-slate-50/80 transition-colors group">
                    <td class="p-3 text-right font-semibold text-slate-700 sticky right-0 z-10 sticky-col-shadow text-xs bg-white group-hover:bg-slate-50/90 transition-colors">
                        <span class="mr-2 text-lg">${habit.icon}</span> ${habit.name}
                    </td>
                    <td class="p-2 font-bold text-slate-400 bg-slate-50/50 border-r border-slate-100">${habit.goal}</td>`;
                
                for(let d=0; d<DAYS_IN_MONTH; d++) {
                    let isWeekEndDay = (d > 0 && DAYS_OF_WEEK[d-1] === 'Ø§Ù„Ø³Ø¨Øª');
                    let tdClasses = "p-1.5 hover:bg-rose-50/50 transition-colors";
                    if(isWeekEndDay) tdClasses += " border-l-2 border-slate-200"; // RTL logic
                    
                    const isChecked = state[hIdx][d] ? 'checked' : '';
                    html += `<td class="${tdClasses}">
                        <input type="checkbox" class="habit-checkbox" data-habit="${hIdx}" data-day="${d}" ${isChecked} onchange="toggleHabit(${hIdx}, ${d})">
                    </td>`;
                }

                html += `
                    <td class="p-2 font-bold text-emerald-600 bg-emerald-50/30 border-r-2 border-slate-200" id="stat-comp-${hIdx}">0</td>
                    <td class="p-2 font-medium text-slate-400 bg-slate-50/50" id="stat-left-${hIdx}">0</td>
                    <td class="p-2 font-bold text-rose-600 bg-rose-50/50" id="stat-perc-${hIdx}">0%</td>
                    <td class="p-2 bg-slate-50/50 text-right px-3 align-middle">
                        <div class="w-full bg-slate-200 h-2.5 rounded-full overflow-hidden shadow-inner">
                            <div id="stat-bar-${hIdx}" class="bg-gradient-to-l from-rose-400 to-rose-500 h-full rounded-full transition-all duration-700 ease-out" style="width: 0%"></div>
                        </div>
                    </td>
                    <td class="p-2 font-bold text-amber-500 bg-amber-50/30" id="stat-cstreak-${hIdx}">0</td>
                    <td class="p-2 font-bold text-purple-600 bg-purple-50/30" id="stat-mstreak-${hIdx}">0</td>
                </tr>`;
            });
            
            if(habitsData.length === 0) {
                 html += `<tr><td colspan="${6 + DAYS_IN_MONTH}" class="p-8 text-center text-slate-400 font-bold bg-slate-50">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø§Ø¯Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹. Ø£Ø¶Ù Ø¹Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¨Ø¯Ø¡! âœ¨</td></tr>`;
            }
            
            html += `</tbody>`;
            table.innerHTML = html;
        }

        function renderWeeklyOverviewBars(globalStats) {
            const barsContainer = document.getElementById('weekly-overview-bars');
            const statsContainer = document.getElementById('weekly-overview-stats');
            
            let barsHtml = ''; let statsHtml = '';
            const maxDailyCompletions = habitsData.length || 1;

            for(let i=0; i<DAYS_IN_MONTH; i++) {
                const completed = globalStats.dailyCompletions[i];
                const goal = globalStats.dailyGoals[i];
                const heightPercent = (completed / maxDailyCompletions) * 100;
                
                let isWeekEndDay = (i > 0 && DAYS_OF_WEEK[i-1] === 'Ø§Ù„Ø³Ø¨Øª');
                let marginClass = isWeekEndDay ? 'ml-3' : ''; // RTL logic

                barsHtml += `
                <div class="flex flex-col items-center justify-end w-full h-full ${marginClass} group relative">
                    <div class="absolute -top-7 opacity-0 group-hover:opacity-100 bg-slate-800 text-white text-[10px] py-0.5 px-2 rounded transition-opacity whitespace-nowrap z-10 shadow-lg pointer-events-none">
                        Ø§Ù„ÙŠÙˆÙ… ${i+1}: ${completed} Ù…ÙƒØªÙ…Ù„
                    </div>
                    <div class="w-full max-w-[12px] md:max-w-[16px] bg-gradient-to-t from-rose-300 to-rose-500 rounded-t-md transition-all duration-500 ease-out group-hover:opacity-80" style="height: ${heightPercent}%"></div>
                </div>`;

                statsHtml += `
                <div class="flex flex-col w-full ${marginClass} items-center gap-0.5 mt-1">
                    <span class="text-emerald-500 font-bold">${completed}</span>
                    <span class="text-slate-300 text-[8px]">${goal}</span>
                </div>`;
            }

            barsContainer.innerHTML = barsHtml;
            statsContainer.innerHTML = statsHtml;

            document.getElementById('global-progress-fraction').innerText = `${globalStats.totalCompleted}/${globalStats.totalGoal}`;
            document.getElementById('global-progress-percent').innerText = `${globalStats.overallPercentage}%`;
        }

        function renderTopHabits(topHabits) {
            const container = document.getElementById('top-habits-list');
            let html = '';
            topHabits.forEach((habit, index) => {
                let rankColor = index < 3 ? 'text-rose-500' : 'text-slate-400';
                let rankBg = index < 3 ? 'bg-rose-50' : 'bg-slate-50';

                html += `
                <div class="flex flex-col ${rankBg} border border-slate-100 p-2.5 rounded-lg transition-all hover:shadow-md hover:-translate-y-0.5 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-1 h-full bg-gradient-to-b ${index < 3 ? 'from-rose-400 to-rose-600' : 'from-slate-300 to-slate-400'}"></div>
                    <div class="flex justify-between items-center mb-1.5 pr-2">
                        <div class="flex items-center gap-2">
                            <span class="font-extrabold ${rankColor} text-sm">${index + 1}</span>
                            <span class="font-semibold text-slate-700 flex items-center gap-1.5"><span class="text-base">${habit.icon}</span> ${habit.name}</span>
                        </div>
                        <span class="font-bold text-rose-600 bg-white px-2 py-0.5 rounded shadow-sm border border-slate-100">${habit.percentage}%</span>
                    </div>
                    <div class="w-full bg-slate-200 h-1.5 rounded-full overflow-hidden mr-2">
                        <div class="bg-gradient-to-l ${index < 3 ? 'from-rose-400 to-rose-500' : 'from-slate-400 to-slate-500'} h-full rounded-full transition-all duration-700" style="width: ${habit.percentage}%"></div>
                    </div>
                </div>`;
            });
            if(topHabits.length === 0) {
                 html = `<div class="text-center text-slate-400 mt-4 text-sm font-bold">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>`;
            }
            container.innerHTML = html;
        }

        function initOrUpdateCharts(gStats) {
            const donutCtx = document.getElementById('donutChart').getContext('2d');
            const lineCtx = document.getElementById('lineChart').getContext('2d');

            // --- Gradients ---
            let gradientDonut = donutCtx.createLinearGradient(0, 0, 0, 150);
            gradientDonut.addColorStop(0, '#f43f5e'); gradientDonut.addColorStop(1, '#be123c');

            let gradientLine = lineCtx.createLinearGradient(0, 0, 0, 150);
            gradientLine.addColorStop(0, 'rgba(244, 63, 94, 0.3)'); gradientLine.addColorStop(1, 'rgba(244, 63, 94, 0.0)');

            // --- Donut Chart ---
            if(donutChartInst) donutChartInst.destroy();
            donutChartInst = new Chart(donutCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Ù…ÙƒØªÙ…Ù„', 'Ù…ØªØ¨Ù‚ÙŠ'],
                    datasets: [{
                        data: gStats ? [gStats.overallPercentage, 100 - gStats.overallPercentage] : [0, 100],
                        backgroundColor: [gradientDonut, '#f1f5f9'],
                        borderWidth: 0,
                        cutout: '78%',
                        borderRadius: 10 
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    animation: { animateScale: true, animateRotate: true, duration: 800, easing: 'easeOutQuart' }
                }
            });

            // --- Line Chart ---
            if(lineChartInst) lineChartInst.destroy();
            lineChartInst = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: DAYS_IN_MONTH}, (_, i) => i + 1),
                    datasets: [{
                        label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©',
                        data: gStats ? gStats.dailyCompletions : new Array(DAYS_IN_MONTH).fill(0),
                        borderColor: '#f43f5e',
                        backgroundColor: gradientLine,
                        borderWidth: 3,
                        pointRadius: 0, 
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#f43f5e',
                        pointBorderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: { 
                        legend: { display: false },
                        tooltip: { backgroundColor: 'rgba(15, 23, 42, 0.9)', titleFont: { family: 'Tajawal' }, bodyFont: { family: 'Tajawal' }, padding: 10, cornerRadius: 8, displayColors: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: habitsData.length || 1,
                            ticks: { display: false },
                            grid: { color: '#f1f5f9', drawBorder: false }, border: { display: false }
                        },
                        x: {
                            grid: { display: false, drawBorder: false },
                            ticks: { font: { size: 10, family: 'Tajawal' }, color: '#94a3b8' }, border: { display: false }
                        }
                    },
                    animation: { duration: 800, easing: 'easeOutQuart' }
                }
            });
        }

        // --- 6. UPDATE ROUTINES ---

        window.toggleHabit = function(habitIndex, dayIndex) {
            state[habitIndex][dayIndex] = !state[habitIndex][dayIndex];
            updateRowUI(habitIndex);
            updateGlobalUI();
        };

        function updateRowUI(habitIndex) {
            const stats = calculateHabitStats(habitIndex);
            document.getElementById(`stat-comp-${habitIndex}`).innerText = stats.completed;
            document.getElementById(`stat-left-${habitIndex}`).innerText = stats.left;
            document.getElementById(`stat-perc-${habitIndex}`).innerText = `${stats.percentage}%`;
            document.getElementById(`stat-bar-${habitIndex}`).style.width = `${stats.percentage}%`;
            document.getElementById(`stat-cstreak-${habitIndex}`).innerText = stats.currentStreak;
            document.getElementById(`stat-mstreak-${habitIndex}`).innerText = stats.maxStreak;
        }

        function updateGlobalUI(isFullRebuild = false) {
            const gStats = calculateGlobalStats();

            if(isFullRebuild) {
                initOrUpdateCharts(gStats);
            } else {
                donutChartInst.data.datasets[0].data = [gStats.overallPercentage, 100 - gStats.overallPercentage];
                donutChartInst.update();
                
                lineChartInst.data.datasets[0].data = gStats.dailyCompletions;
                lineChartInst.options.scales.y.max = habitsData.length || 1;
                lineChartInst.update();
            }

            const pctElement = document.getElementById('overall-percentage');
            pctElement.innerText = `${gStats.overallPercentage}%`;
            pctElement.classList.add('scale-110', 'text-rose-500');
            setTimeout(() => pctElement.classList.remove('scale-110', 'text-rose-500'), 200);

            document.getElementById('overall-left').innerText = `Ù…ØªØ¨Ù‚ÙŠ: ${100 - gStats.overallPercentage}%`;
            document.getElementById('overall-completed').innerText = `Ù…ÙƒØªÙ…Ù„: ${gStats.overallPercentage}%`;

            renderWeeklyOverviewBars(gStats);
            renderTopHabits(gStats.topHabits);
        }

        function rebuildUI() {
            renderTable();
            habitsData.forEach((_, index) => updateRowUI(index));
            updateGlobalUI(true);
        }

        // --- 7. STARTUP ---
        window.onload = () => {
            initCalendarSelects();
            calculateCalendarData();
            rebuildUI();
        };

    </script>
</body>
</html>
